{% extends 'core/plantilla/app.html' %}
{% load static %}
{% load form_filters %}
{% block title %}{% if es_edicion %}Editar{% else %}Registrar{% endif %} Pago{% endblock %}

{% block content %}
<div class="form-container">
  <div class="form-header">
    <img src="https://cdn-icons-png.flaticon.com/512/2921/2921822.png" alt="Icono pago">
    <h2>{% if es_edicion %}Editar{% else %}Registrar{% endif %} Pago</h2>
  </div>


  <form method="POST" onsubmit="return validarFormularioPago();">
    {% csrf_token %}

  <!-- Cuenta -->
  <div class="mb-4">
    {% if form.cuenta.errors %}
      <p class="help is-danger">{{ form.cuenta.errors.0 }}</p>
    {% endif %}
    <div class="input-div">
      <i class="fas fa-file-invoice-dollar"></i>
      {{ form.cuenta|add_class:"form-control" }}
    </div>
  </div>




    <!-- Fecha de pago -->
    <div class="mb-4">
      {% if form.fecha_pago.errors %}
          <p class="help is-danger">{{ form.fecha_pago.errors.0 }}</p>
      {% endif %}
      <div class="input-div">
          <i class="fas fa-calendar-check"></i>
          {{ form.fecha_pago }}
          <p id="fecha_pago-error" class="help is-danger is-hidden">La fecha de pago es obligatoria.</p>
      </div>
    </div>


    <!-- Monto pagado -->
    <div class="mb-4">
      <div class="input-div">
        <i class="fas fa-money-check-alt"></i>
        {{ form.monto_pagado }}
      </div>
      <p id="monto-error" class="help is-danger is-hidden">El monto debe ser mayor a 0 y no exceder el saldo pendiente.</p>
    </div>

    <!-- Información dinámica -->
    <div id="info-cuenta" class="alert alert-info d-none">
      <p><strong>Proveedor:</strong> <span id="proveedor-nombre"></span></p>
      <p><strong>Documento:</strong> <span id="nro-documento"></span></p>
      <p><strong>Monto Total:</strong> S/ <span id="monto-total"></span></p>
      <p><strong>Abonado:</strong> S/ <span id="monto-abonado"></span></p>
      <p><strong>Saldo pendiente:</strong> <strong>S/ <span id="saldo-pendiente">0.00</span></strong></p>
    </div>

    <!-- Botón pagar total -->
    <button type="button" class="btn btn-outline-success mb-3 d-none" id="btn-pagar-total" onclick="pagarTotal()">
      Pagar Total
    </button>

    <div class="d-flex justify-content-center gap-3 mt-4">
      <button type="submit" class="btn btn-success" id="btn-guardar">
        <i class="fas fa-save me-2"></i> Guardar Pago
      </button>
      <a href="{% url 'listar_cuentas' %}" class="btn btn-danger">
        <i class="fas fa-ban me-2"></i> Cancelar
      </a>
    </div>

  </form>
</div>

<!-- Datos JSON -->
<script id="datos-cuentas" type="application/json">
  {
    {% for cuenta in form.fields.cuenta.queryset %}
      "{{ cuenta.pk }}": {
        "saldo": {{ cuenta.saldo_pendiente|floatformat:2 }},
        "proveedor": "{{ cuenta.proveedor.nombre|escapejs }}",
        "documento": "{{ cuenta.nro_documento|escapejs }}",
        "total": {{ cuenta.monto_total|floatformat:2 }},
        "abonado": {{ cuenta.monto_abonado|floatformat:2 }}
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  }
</script>

<!-- Scripts -->
<script>
  const btnGuardar = document.getElementById("btn-guardar");
  const cuentasInfo = JSON.parse(document.getElementById("datos-cuentas").textContent);
  const cuentaSelect = document.getElementById("id_cuenta");
  const montoInput = document.getElementById("id_monto_pagado");
  const saldoSpan = document.getElementById("saldo-pendiente");
  const infoDiv = document.getElementById("info-cuenta");
  const btnPagarTotal = document.getElementById("btn-pagar-total");
  const errorMonto = document.getElementById("monto-error");
  const fecha_pago = document.getElementById("fecha_pago-error");
  
    

  function actualizarSaldo() {
    const cuentaId = cuentaSelect.value;
    const datos = cuentasInfo[cuentaId];
    if (datos) {
      document.getElementById("proveedor-nombre").textContent = datos.proveedor;
      document.getElementById("nro-documento").textContent = datos.documento;
      document.getElementById("monto-total").textContent = datos.total.toFixed(2);
      document.getElementById("monto-abonado").textContent = datos.abonado.toFixed(2);
      saldoSpan.textContent = datos.saldo.toFixed(2);
      infoDiv.classList.remove("d-none");
      btnPagarTotal.classList.remove("d-none");
    } else {
      infoDiv.classList.add("d-none");
      btnPagarTotal.classList.add("d-none");
    }
    validarMonto();
  }

  function pagarTotal() {
    const cuentaId = cuentaSelect.value;
    const datos = cuentasInfo[cuentaId];
    if (datos) {
      montoInput.value = datos.saldo.toFixed(2);
      validarMonto();
    }
  }

  function validarMonto() {
    const cuentaId = cuentaSelect.value;
    const datos = cuentasInfo[cuentaId];
    const valor = parseFloat(montoInput.value);

    if (!datos || isNaN(valor) || valor <= 0 || valor > datos.saldo) {
    errorMonto.classList.remove('is-hidden');
    btnGuardar.disabled = true;
    return false;
  } else {
    errorMonto.classList.add('is-hidden');
    btnGuardar.disabled = false;
    return true;
  }
  }
  function validarFecha() {
    const fechaInput = document.getElementById("id_fecha_pago");
    const errorFecha = document.getElementById("fecha_pago-error");

    if (!fechaInput.value) {
      errorFecha.classList.remove("is-hidden");

      return false;
    } else {
      errorFecha.classList.add("is-hidden");
      return true;
    }
  }


  function validarFormularioPago() {
    const esMontoValido = validarMonto();
    const esFechaValida = validarFecha();
    return esMontoValido && esFechaValida;
  }


  // Eventos
  cuentaSelect.addEventListener("change", actualizarSaldo);
  montoInput.addEventListener("input", validarMonto);

  // Inicializar
  actualizarSaldo();

  // Flatpickr
  document.addEventListener('DOMContentLoaded', function () {
    flatpickr("input[name='fecha_pago']", {
      dateFormat: "Y-m-d",
      locale: "es"

      
    });
  });
  
</script>
{% endblock %}
